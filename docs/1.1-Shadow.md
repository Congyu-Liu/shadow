This page describes how to setup and install Shadow from a bare-bones Linux installation and is the recommended setup and installation method.

## Supported Platforms

Shadow officially supports the following platforms:

  + Ubuntu 16.04, 18.04, and 20.04
  + Debian 10
  + Fedora 32
  + CentOS 7, 8

If you are installing Shadow within a Docker container, you must increase the size of the container's `/dev/shm` mount by passing `--shm-size="1g"` (with a suitable size for your system and experiments) to `docker run`.

If you are having difficulty installing Shadow on any of these platforms, you may find the [continuous integration build steps](https://github.com/shadow/shadow/blob/master/.github/workflows/run_tests.yml) helpful.

We do not provide official support for other platforms. This means that we do not ensure that Shadow successfully builds and passes tests on other platforms. However, we will review pull requests that allow Shadow to build and run on unsupported platforms.

## Installing Dependencies

#### Required:
  + gcc, gcc-c++
  + python 3 (version >= 3.6)
  + PyYAML
  + glib (version >= 2.32.0)
  + igraph (version >= 0.5.4)
  + cmake (version >= 3.2)
  + make
  + xz-utils
  + glibc debuginfo
  + procps
  + cargo

#### Recommended Python Modules (for helper/analysis scripts):
  + numpy, scipy, matplotlib, networkx, lxml

#### Recommended System Tools:
  + git, dstat, screen, htop

#### YUM (Fedora/CentOS):

In more recent versions of Fedora and CentOS, `yum` can be exchanged for `dnf` in these commands.
Before running these commands, please check any platform-specific requirements below.

**Warning:** YUM and DNF often install 32-bit (`i686`) versions of libraries. You may want to use the `--best` option to make sure you're installing the 64-bit (`x86_64`) versions, which are required by Shadow.

```bash
sudo yum install -y \
    cmake \
    findutils \
    glib2 \
    glib2-devel \
    igraph \
    igraph-devel \
    make \
    procps-devel \
    python3 \
    python3-pip \
    xz \
    xz-devel \
    yum-utils \
    diffutils \
    gcc \
    gcc-c++ \
    cargo
python3 -m pip install pyyaml
sudo yum install -y \
    python3-numpy \
    python3-lxml \
    python3-matplotlib \
    python3-networkx \
    python3-scipy \
    python3-yaml
sudo yum install -y \
    dstat \
    git \
    htop \
    screen
```

##### CentOS 7

You must enable the EPEL repository using:

```
yum install -y https://dl.fedoraproject.org/pub/epel/epel-release-latest-7.noarch.rpm
```

Instead of installing `cmake`, you should instead install `cmake3`:

```
yum install -y cmake3
alternatives --install /usr/local/bin/cmake cmake /usr/bin/cmake3 20 \
    --slave /usr/local/bin/ctest ctest /usr/bin/ctest3 \
    --slave /usr/local/bin/cpack cpack /usr/bin/cpack3 \
    --slave /usr/local/bin/ccmake ccmake /usr/bin/ccmake3 \
    --family cmake
```

As cargo is not available on CentOS 7, you can install cargo following the steps at https://rustup.rs/.

##### CentOS 8

As procps-ng-devel, igraph, and igraph-devel are not available on CentOS 8, you must install them manually.

```
dnf remove -y procps-ng procps-ng-devel
dnf install -y http://vault.centos.org/centos/7.7.1908/os/x86_64/Packages/procps-ng-3.3.10-26.el7.x86_64.rpm
dnf install -y http://vault.centos.org/centos/7.7.1908/os/x86_64/Packages/procps-ng-devel-3.3.10-26.el7.x86_64.rpm
dnf install -y https://dl.fedoraproject.org/pub/archive/epel/7.7/x86_64/Packages/i/igraph-0.7.1-12.el7.x86_64.rpm
dnf install -y https://dl.fedoraproject.org/pub/archive/epel/7.7/x86_64/Packages/i/igraph-devel-0.7.1-12.el7.x86_64.rpm
```

#### APT (Debian/Ubuntu):

Before running these commands, please check any platform-specific requirements below.

```bash
sudo apt-get install -y \
    cmake \
    findutils \
    libc-dbg \
    libglib2.0-0 \
    libglib2.0-dev \
    libigraph0-dev \
    libigraph0v5 \
    libprocps-dev \
    make \
    python3 \
    python3-pip \
    xz-utils \
    gcc \
    g++ \
    cargo
python3 -m pip install pyyaml
sudo apt-get install -y \
    python3-numpy \
    python3-lxml \
    python3-matplotlib \
    python3-networkx \
    python3-scipy \
    python3-yaml
sudo apt-get install -y \
    dstat \
    git \
    htop \
    screen
```

##### Ubuntu 16.04

As Python >= 3.6 is not available on Ubuntu 16.04, you can install it from a PPA such as https://launchpad.net/~deadsnakes/+archive/ubuntu/ppa/.

## Shadow Setup

```bash
git clone https://github.com/shadow/shadow.git
cd shadow
./setup build --clean --test
./setup test
./setup install
```

You should add `/home/${USER}/.shadow/bin` to your shell setup for the PATH environment variable (e.g., in `~/.bashrc` or `~/.bash_profile`).

```bash
echo 'export PATH="${PATH}:/home/${USER}/.shadow/bin"' >> ~/.bashrc && source ~/.bashrc
```

Check that Shadow is installed and runs:

```bash
shadow --version
shadow --help
```

#### Setup Notes

  + All build output is generated out-of-source, by default to the `./build` directory.
  + Use `./setup build --help` to see all build options; the most useful build options are:  
    + `-g` or `--debug` to build Shadow with debugging symbols
    + `--include` and `--library` if you installed any dependencies in non-standard locations or somewhere other than `~/.shadow`.
    + `--prefix` if you want to install Shadow somewhere besides `~/.shadow`
  + The `setup` script is a wrapper to `cmake` and `make`. Using `cmake` and `make` directly is also possible, but strongly discouraged.

## TGen Setup

Installing Shadow gives you the simulation environment, but you'll almost certainly want to run some processes inside of Shadow. The [TGen traffic generator](https://github.com/shadow/tgen) is useful for generating and transferring traffic through Shadow.

TGen was moved to its own repo on April 3, 2019 as of [this commit](https://github.com/shadow/shadow/commit/75973e75a6ab7d08ff0f04d9aab47fc0e4e97d89) for organizational reasons, but installing it is easy (TGen's dependencies are a subset of Shadow's):

```bash
git clone git@github.com:shadow/tgen.git
cd tgen && mkdir build && cd build
cmake .. -DCMAKE_INSTALL_PREFIX=/home/$USER/.shadow
make && make install
```

Now you can run `~/.shadow/bin/tgen` either inside of Shadow, or outside of Shadow. See the [TGen repo](https://github.com/shadow/tgen) for more info.

## System Configs and Limits

Some Linux system configuration changes are needed to run large-scale Shadow simulations (more than about 1000 nodes).

#### Number of Open Files

There is a default linux system limit on the number of open files. If each node 
in your Shadow plug-in opens many file or socket descriptors (if you have many nodes, this is very likely to happen), you'll likely want to increase the limit so you application doesn't start getting errors when calling `open()` or `socket()`.

###### System-wide Limits

Check the _system-wide_ limits with:

```bash
sysctl fs.nr_open # per-process open file limit
sysctl fs.file-max # system-wide open file limit
```

Use `cat /proc/sys/fs/file-nr` to find:
 1. the current, system-wide number of used file handles
 1. the current, system-wide number of free file handles
 1. and the system-wide limit on the maximum number of open files for all processes

Change the limits, persistent across reboots, and apply now:

```bash
sysctl -w fs.nr_open=10485760
echo "fs.nr_open = 10485760" >> /etc/sysctl.conf
sysctl -w fs.file-max=10485760
echo "fs.file-max = 10485760" >> /etc/sysctl.conf
sysctl -p
```

###### User Limits

Check the maximum number of open file descriptors _currently allowed_ in your session:
```bash
ulimit -n
```

Check the number of files _currently used_ in a process with pid=PID:
```bash
/bin/ls -l /proc/PID/fd/ | wc -l
```

You will want to almost certainly want to raise the user file limit by modifying `/etc/security/limits.conf`. For example:

```
rjansen soft nofile 10485760
rjansen hard nofile 10485760
```

The max you can use is your `fs.nr_open` system-wide limit setting from above. You need to either log out and back in or reboot for the changes to take affect. You can watch `/proc/sys/fs/file-nr` and reduce the limit according to your usage, if you'd like.

#### Number of Maps

There is a system limit on the number of `mmap()` mappings per process. Most users will not have to modify these settings. However, if an application running in Shadow makes extensive use of `mmap()`, you may need to increase the limit.

###### Process Limit

The process limit can be queried in these ways:

```bash
sysctl vm.max_map_count
cat /proc/sys/vm/max_map_count
```

You can check the number of maps currently used in a process with pid=PID like this:

```bash
wc -l /proc/PID/maps
```

Set a new limit, make it persistent, apply it now:

```bash
sudo sysctl -w vm.max_map_count=1073741824
sudo echo "vm.max_map_count = 1073741824" >> /etc/sysctl.conf
sudo sysctl -p
```

#### For more information

https://www.kernel.org/doc/Documentation/sysctl/fs.txt  
https://www.kernel.org/doc/Documentation/sysctl/vm.txt

```bash
man proc
man ulimit
cat /proc/sys/fs/file-max
cat /proc/sys/fs/inode-max
```
